{%- if cart != empty -%}
  <div class="container">
    <div class="cart-header">
      <h1>{{ 'sections.cart.title' | t }}</h1>
      <a href="{{ routes.collections_url }}" class="cart-continue-shopping">
        {{ 'sections.cart.continue_shopping' | t }}
      </a>
    </div>

    <form action="{{ routes.cart_url }}" method="post" novalidate class="cart-form">
      <div class="cart-content">
        <div class="cart-items">
          {%- for item in cart.items -%}
            <div class="cart-item" id="CartItem-{{ item.index | plus: 1 }}">
              <div class="cart-item-image">
                {%- if item.image -%}
                  <img src="{{ item.image | img_url: '200x' }}" 
                       alt="{{ item.image.alt | default: item.product.title | escape }}"
                       loading="lazy">
                {%- endif -%}
              </div>

              <div class="cart-item-details">
                <h3 class="cart-item-title">
                  <a href="{{ item.url }}">{{ item.product.title }}</a>
                </h3>
                
                {%- if item.original_price != item.final_price -%}
                  <div class="cart-item-discounted-prices">
                    <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
                    <s class="cart-item-old-price product-option">
                      {{ item.original_price | money }}
                    </s>
                    <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
                    <strong class="cart-item-final-price product-option">
                      {{ item.final_price | money }}
                    </strong>
                  </div>
                {%- else -%}
                  <div class="product-option">
                    {{ item.original_price | money }}
                  </div>
                {%- endif -%}

                {%- if item.product.has_only_default_variant == false or item.properties.size != 0 or item.selling_plan_allocation != nil -%}
                  <dl>
                    {%- if item.product.has_only_default_variant == false -%}
                      {%- for option in item.options_with_values -%}
                        <div class="product-option">
                          <dt>{{ option.name }}: </dt>
                          <dd>{{ option.value }}</dd>
                        </div>
                      {%- endfor -%}
                    {%- endif -%}

                    {%- for property in item.properties -%}
                      {%- assign property_first_char = property.first | slice: 0 -%}
                      {%- if property.last != blank and property_first_char != '_' -%}
                        <div class="product-option">
                          <dt>{{ property.first }}: </dt>
                          <dd>
                            {%- if property.last contains '/uploads/' -%}
                              <a href="{{ property.last }}" class="link" target="_blank">
                                {{ property.last | split: '/' | last }}
                              </a>
                            {%- else -%}
                              {{ property.last }}
                            {%- endif -%}
                          </dd>
                        </div>
                      {%- endif -%}
                    {%- endfor -%}
                  </dl>

                  <p class="product-option">{{ item.selling_plan_allocation.selling_plan.name }}</p>
                {%- endif -%}

                <div class="cart-item-error" id="Line-item-error-{{ item.index | plus: 1 }}" role="status">
                  <small class="cart-item-error-text"></small>
                  <svg aria-hidden="true" focusable="false" class="icon icon-error" viewBox="0 0 13 13">
                    <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                    <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                    <path d="m5.87413 3.52832c0-0.77135 0.63425-1.39862 1.41656-1.39862 0.77135 0 1.41656 0.62727 1.41656 1.39862 0 0.77136-0.63521 1.39863-1.41656 1.39863-0.78231 0-1.41656-0.62727-1.41656-1.39863zm1.41656 7.43618c-0.84973 0-1.54166-0.69194-1.54166-1.54167 0-0.84973 0.69193-1.54166 1.54166-1.54166 0.84973 0 1.54167 0.69193 1.54167 1.54166 0 0.84973-0.69194 1.54167-1.54167 1.54167z" fill="white"/>
                    <path d="m5.87413 3.17832c0-0.77135 0.63425-1.39862 1.41656-1.39862 0.77135 0 1.41656 0.62727 1.41656 1.39862 0 0.77136-0.63521 1.39863-1.41656 1.39863-0.78231 0-1.41656-0.62727-1.41656-1.39863zm1.41656 7.78618c-0.84973 0-1.54166-0.69194-1.54166-1.54167 0-0.84973 0.69193-1.54166 1.54166-1.54166 0.84973 0 1.54167 0.69193 1.54167 1.54166 0 0.84973-0.69194 1.54167-1.54167 1.54167z" fill="#EB001B"/>
                  </svg>
                </div>
              </div>

              <div class="cart-item-quantity">
                <div class="cart-item-quantity-wrapper">
                  <label class="visually-hidden" for="Quantity-{{ item.index | plus: 1 }}">
                    {{ 'products.product.quantity.label' | t }}
                  </label>
                  <quantity-input class="quantity">
                    <button class="quantity__button no-js-hidden" name="minus" type="button">
                      <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}</span>
                      {% render 'icon-minus' %}
                    </button>
                    <input class="quantity__input"
                      type="number"
                      name="updates[]"
                      value="{{ item.quantity }}"
                      min="0"
                      aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                      id="Quantity-{{ item.index | plus: 1 }}"
                      data-index="{{ item.index | plus: 1 }}"
                    >
                    <button class="quantity__button no-js-hidden" name="plus" type="button">
                      <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}</span>
                      {% render 'icon-plus' %}
                    </button>
                  </quantity-input>
                </div>
                <cart-remove-button id="Remove-{{ item.index | plus: 1 }}" data-index="{{ item.index | plus: 1 }}">
                  <a href="{{ item.url_to_remove }}" class="button button--tertiary" aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}">
                    {% render 'icon-remove' %}
                  </a>
                </cart-remove-button>
              </div>

              <div class="cart-item-totals right medium-hide large-up-hide">
                <div class="loading-overlay hidden">
                  <div class="loading-overlay__spinner">
                    <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </div>
                <div class="cart-item-price-wrapper">
                  {%- if item.original_line_price != item.final_line_price -%}
                    <dl class="cart-item-discounted-prices">
                      <dt class="visually-hidden">
                        {{ 'products.product.price.regular_price' | t }}
                      </dt>
                      <dd>
                        <s class="cart-item-old-price price price--end">
                          {{ item.original_line_price | money }}
                        </s>
                      </dd>
                      <dt class="visually-hidden">
                        {{ 'products.product.price.sale_price' | t }}
                      </dt>
                      <dd class="price price--end">
                        {{ item.final_line_price | money }}
                      </dd>
                    </dl>
                  {%- else -%}
                    <span class="price price--end">
                      {{ item.original_line_price | money }}
                    </span>
                  {%- endif -%}

                  {%- if item.variant.available and item.unit_price_measurement -%}
                    <div class="unit-price caption">
                      <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                      {{ item.variant.unit_price | money }}
                      <span aria-hidden="true">/</span>
                      <span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
                      {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                        {{- item.variant.unit_price_measurement.reference_value -}}
                      {%- endif -%}
                      {{ item.variant.unit_price_measurement.reference_unit }}
                    </div>
                  {%- endif -%}
                </div>
              </div>

              <div class="cart-item-totals">
                <div class="loading-overlay hidden">
                  <div class="loading-overlay__spinner">
                    <svg aria-hidden="true" focusable="false" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </div>

                <div class="cart-item-price-wrapper">
                  {%- if item.original_line_price != item.final_line_price -%}
                    <dl class="cart-item-discounted-prices">
                      <dt class="visually-hidden">
                        {{ 'products.product.price.regular_price' | t }}
                      </dt>
                      <dd>
                        <s class="cart-item-old-price price price--end">
                          {{ item.original_line_price | money }}
                        </s>
                      </dd>
                      <dt class="visually-hidden">
                        {{ 'products.product.price.sale_price' | t }}
                      </dt>
                      <dd class="price price--end">
                        {{ item.final_line_price | money }}
                      </dd>
                    </dl>
                  {%- else -%}
                    <span class="price price--end">
                      {{ item.original_line_price | money }}
                    </span>
                  {%- endif -%}

                  {%- if item.variant.available and item.unit_price_measurement -%}
                    <div class="unit-price caption">
                      <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
                      {{ item.variant.unit_price | money }}
                      <span aria-hidden="true">/</span>
                      <span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
                      {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                        {{- item.variant.unit_price_measurement.reference_value -}}
                      {%- endif -%}
                      {{ item.variant.unit_price_measurement.reference_unit }}
                    </div>
                  {%- endif -%}
                </div>
              </div>
            </div>
          {%- endfor -%}
        </div>

        <div class="cart-summary">
          <div class="cart-summary-content">
            <div class="js-contents">
              <div class="totals">
                <h2 class="totals__title">{{ 'sections.cart.totals' | t }}</h2>
                <div class="totals__subtotal">
                  <p class="totals__subtotal-value">{{ cart.total_price | money_with_currency }}</p>
                </div>
              </div>

              <small class="tax-note caption-large rte">
                {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                  {{ 'sections.cart.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
                {%- elsif cart.taxes_included -%}
                  {{ 'sections.cart.taxes_included_but_shipping_at_checkout' | t }}
                {%- elsif shop.shipping_policy.body != blank -%}
                  {{ 'sections.cart.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
                {%- else -%}
                  {{ 'sections.cart.taxes_and_shipping_at_checkout' | t }}
                {%- endif -%}
              </small>
            </div>

            <div class="cart__ctas">
              <noscript>
                <button type="submit" class="cart__update-button button button--secondary" form="cart">
                  {{ 'sections.cart.update' | t }}
                </button>
              </noscript>

              <button type="submit" id="checkout" class="cart__checkout-button button" name="commit" form="cart">
                {{ 'sections.cart.checkout' | t }}
              </button>
            </div>

            <div id="cart-errors"></div>
          </div>
        </div>
      </div>
    </form>
  </div>
{%- else -%}
  <div class="cart-empty">
    <div class="container">
      <h1>{{ 'sections.cart.empty' | t }}</h1>
      <a href="{{ section.settings.continue_shopping_url | default: routes.collections_url }}" class="button">
        {{ 'general.continue_shopping' | t }}
      </a>
    </div>
  </div>
{%- endif -%}

<script>
  class CartRemoveButton extends HTMLElement {
    constructor() {
      super();

      this.addEventListener('click', (event) => {
        event.preventDefault();
        const cartItems = this.closest('cart-items') || this.closest('cart-drawer-items');
        cartItems.updateQuantity(this.dataset.index, 0);
      });
    }
  }

  customElements.define('cart-remove-button', CartRemoveButton);

  class QuantityInput extends HTMLElement {
    constructor() {
      super();
      this.input = this.querySelector('input');
      this.changeEvent = new Event('change', { bubbles: true })

      this.querySelectorAll('button').forEach(
        (button) => button.addEventListener('click', this.onButtonClick.bind(this))
      );
    }

    onButtonClick(event) {
      event.preventDefault();
      const previousValue = this.input.value;

      event.target.name === 'plus' ? this.input.stepUp() : this.input.stepDown();
      if (previousValue !== this.input.value) this.input.dispatchEvent(this.changeEvent);
    }
  }

  customElements.define('quantity-input', QuantityInput);
</script>

{% schema %}
{
  "name": "t:sections.main-cart.name",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "t:sections.main-cart.settings.show_vendor.label"
    },
    {
      "type": "url",
      "id": "continue_shopping_url",
      "label": "Lien continuer les achats"
    }
  ]
}
{% endschema %}